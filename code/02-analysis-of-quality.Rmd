---
title: "R Notebook"
output: html_notebook
---


```{r setup}
library(ggplot2)
library(bitops)
library(RCurl)
source(file="C:/Master/apuntes-articulo-feature-selection/code/preproceso_1.R",encoding = "UTF8")
#funciones online
script <- getURL("https://raw.githubusercontent.com/arturo-laflor/util-R-codes/master/QOfCategoricalF.R", ssl.verifypeer = FALSE)
eval(parse(text = script),envir=.GlobalEnv)

script <- getURL("https://raw.githubusercontent.com/arturo-laflor/util-R-codes/master/QOfContinuousF.R", ssl.verifypeer = FALSE)
eval(parse(text = script),envir=.GlobalEnv)

script <- getURL("https://raw.githubusercontent.com/arturo-laflor/util-R-codes/master/multiplot.R", ssl.verifypeer = FALSE)
eval(parse(text = script),envir=.GlobalEnv)

knitr::opts_chunk$set(echo = FALSE)

setwd("C:/Master/apuntes-articulo-feature-selection")
```


# Estructuration and validation data process

Before to generate the quality report of the data, the data are loaded and passed for a process of validation and restructuration. This process includes the renaming of the columns and data validation for columns as time and age. Additionally, the values for the responses of SHI and PSQI questionnaires was recodified from original responses ('Nunca','Casi nunca','Algunas veces','Frecuentemente','Siempre') to data that can be used to numerical and algorithmical analysis ('0','1','2','3','4').

```{r lee_data_set_original, echo=FALSE}
user<-Sys.info()[7]
user<-user[[1]]
ruta<-paste("C:/Users/",user,"/Google Drive/Doctorado/Tesis/Data/",sep = "") 
  d_crudos<-read.csv(file=paste(ruta,"responses.csv",sep = ""),header = T,sep = ",")

QS_data<-preproceso_1(d_crudos,2)
  
```

The resulting dataset has `r dim(QS_data)[2]` columns, distributet as the following table shows:

| Type        | Quantity | Columns in the dataset |
|-------------|----------|------------------------|
| CharID      | 1        | 1                      |
| Categorical | 41       | [3-9] and [14-48]      |
| Continuous  | 6        | 2 and [10-13]          |


Exploring the data, allow to identify three records that contains no data for any feature in the dataset, this three records was deleted from the dataset to avoid noisy in following analysis.


# Data quality report

A report of data quality was performed at this time, showing the main metrics for the continuous and categorical variables respectively. For categorical variables, nine metrics were analyzed: quantity, missing values, cardinality, mode, mode frequency, mode percent, second mode, second mode frequency and second mode percent, while for continuous variables ten metrics were analyzed: quantity, missing values, cardinality, minimum value, first quartile, median, third quartile, maximum value, mean, and standard deviation. 

## Continuous features
The dataset contains five continuous features, one for demographic data (DD1=AGE) and four features that measure the sleep duration (SQ1="Time to go to bed", SQ2="Latency of sleep", SQ3="Time to wake up", SQ4="Period of time between going to bed and waking up").


```{r report-of-quality-contfeat}
dfCONTFEAT<-cbind.data.frame(DD1=QS_data[,2],QS_data[,10:13])
DRCONT<-QOfContinuousF(dfCONTFEAT)
DRCONT

```
Table:Report of qulaity of the continuos features

### Generalities
The table \@ref(Report of quality of the continuos features) shows some irregularities in continuous variables, as we can see, a negative value is the minimum value in the SQ4 variable; this variable represents the *Period of time between going to bed and waking up*, thus no negative value must be enter in this field, likewise, it appear a $0.0$ value as the minimun value in the SQ1 variable, which is wrong because this is the time that respondents said go to bed, and, in this case, $0.00$ is not a valid answer, in any case, an appropriate answer would be $12.00$, referring to midnight. On the other hand, the variable SQ2, has a large standard deviation ($\sigma=11.91$), since the variable represents the minutes that person takes to fall asleep in minutes ($\mu\simeq 15$). 

### Missing values
No one of these features have a great quantity of missing values, DD1 is the variable with most of them, however the missing values represents only the $`r round(max(DRCONT[,2])/dim(QS_data)[1],digits=3)` \%$ of the data, whis is not significant. If we assume that each record that contains a missing value is a different row, we have $`r sum(DRCONT[,2])`$ records, which represents the 
$`r round(sum(DRCONT[,2])/dim(QS_data)[1],digits=3)`\%$. As this percentage is small, and there are not in our hands, previous works describing the tendency of the data, these records with missing values could be deleted. 

### Cardinality
These continuos variables shows good cardinality, even though the ratio between the cardinality and number of records is not close to one. The nature of the data justifies this fact, because although the features are continuous and in theory they could take a large number of values, they take a small range of values, for instance, the variable SQ1 take an small range of values because the people answer commonly to this kind of question with onclock time, it means, people ask that they go to bed at $9:00$, $10:30$, $10:45$ or $11:00$, even when they, actually were to bed at $9:03$, or $10:33$ referring to the first to examples. The other variables have similar nature, thus the conclusion that cardinality is good for this variables, where the smallest cardinality was 15.

The Table \@ref(tab-data-quality-plan) summarizes the data quality issues and the potential strategies to attend them.


| Feature | Data quality issue                                                                        | Strategie                                                                                                                                                                                                               |
|---------|-------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| SQ1     | Data contain 0.0, the correct value should be 12.00                                       | Refine the process of convert data for this field                                                                                                                                                                       |
| SQ4     | Data contain negative values, it is wrong because the data represents the time to wake up | Refine the process validating the data, to correct the problem, or, eliminate the records with this issue.                                                                                                              |
| SQ2     | Standar deviation too large                                                               | Finding outliers visually and analytically. Excluding outliers from the modeling may improve the predictions. These analysis of outliers includes all continuous variables.                                             |
| All     | Missing values                                                                            | The percentage of missing values is low, it allows to eliminate records with missing values. The decision of impute data is a few probable, since no reports are in our bibliography to know the tendency of the data.  |


<!-- \begin{table}[] -->
<!-- \centering -->
<!-- \caption{My caption} -->
<!-- \label{my-label} -->
<!-- \begin{tabular}{|l|l|l|} -->
<!-- \hline -->
<!-- Feature & Data quality issue                                                                        & Strategie                                                                                                                                                                                                              \\ \hline -->
<!-- SQ1     & Data contain 0.0, the correct value should be 12.00                                       & Refine the process of convert data for this field                                                                                                                                                                      \\ \hline -->
<!-- SQ4     & Data contain negative values, it is wrong because the data represents the time to wake up & Refine the process validating the data, to correct the problem, or, eliminate the records with this issue.                                                                                                             \\ \hline -->
<!-- SQ2     & Standar deviation too large                                                               & Finding outliers visually and analytically. Excluding outliers from the modeling may improve the predictions. These analysis of outliers includes all continuous variables.                                            \\ \hline -->
<!-- All     & Missing values                                                                            & The percentage of missing values is low, it allows to eliminate records with missing values. The decision of impute data is a few probable, since no reports are in our bibliography to know the tendency of the data. \\ \hline -->
<!-- \end{tabular} -->
<!-- \end{table} -->

## Categorical Features
The categorical features were divided in two groups, the demographic features are in the first group and the features containing all the information over the sleep hygiene are in other group.

### Demographics
```{r report-of-quality-catdemofeat}
DRCATDEMO<-QOfCategoricalF( cbind.data.frame(QS_data[,3:9]))

DRCATDEMO

```
Table: Report-of-quality-of-the-categorical-demographic-features


The table \@ref(Report-of-quality-of-the-categorical-demographic-features) shows only one irregularity in this set of variables, the variable DD6 has the hihest mode posible ($100%$), if data are right, all respondents are living in free union status  which is very doubtful taken in account the population were the questionnaire was applied. There are less missing values than in the continuous features, so, it is possible to think in eliminate the records. The cardinality is not a problem in this set of features (except for the variable DD6 as commented above), since all posibilities have representation. In the two cases (features DD7 and DD8) where the mode capture a high percentage of the data, the information is good for this research. DD7 refers to people who suffer some chronic disease, the best answer to this work is "Any" because the intention is to work with healthy people, likewise in the DD8 variable that ask to the people if they are in some crisis that disrups their sleep, the best answer to this work is "No", fortunatelly, this is the mode.


| Feature | Data quality issue                         | Strategie                                                                                                                                     |
|---------|--------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------|
| DD6     | The mode represents the 100% of the data.  | Observation of the raw data and analysis of the process of the data restructuring to identify a possible bug.                                 |
| All     | Missing values                             | The percentage of missing values is very small, it allows to eliminate records with missing values. No imputation is pertinent for this data. |

<!-- \begin{table}[] -->
<!-- \centering -->
<!-- \caption{My caption} -->
<!-- \label{my-label} -->
<!-- \begin{tabular}{lll} -->
<!-- \hline -->
<!-- \multicolumn{1}{|l|}{Feature} & \multicolumn{1}{l|}{Data quality issue}                         & \multicolumn{1}{l|}{Strategie}                                                                                                                \\ \hline -->
<!-- \multicolumn{1}{|l|}{DD6}     & \multicolumn{1}{l|}{The mode represents the 100\% of the data.} & \multicolumn{1}{l|}{Observation of the raw data and analysis of the process of the data restructuring to identify a possible bug.}            \\ \hline -->
<!-- All                           & Missing values                                                  & The percentage of missing values is very small, it allows to eliminate records with missing values. No imputation is pertinent for this data. -->
<!-- \end{tabular} -->
<!-- \end{table} -->

### Slepp hygiene

```{r report-of-quality-catshfeat}
DRCATSH<-QOfCategoricalF(cbind.data.frame(QS_data[,28:48]))

DRCATSH
```
Table: Report of quality of the sleep hygiene features


In Table \@ref(Report-of-quality-of-the-sleep-hygiene-features), the cardinality shows that all possible value $[0-5]$ for each answer is represented in the data, except by the SH9 variable where one of the options was not selected as answer of the respondents. It is good for the quality of data, however, there are two variables with high mode. The 81.66 % of the respondents, answered *never ($0$)*  to the question SH9 *"I use alcohol within 4 hours of going to bed or after going to bed."*, while the 94.38% answered *never ($0$)*  to the question SH8 *"I use tobacco within 4 hours of going to bed or after going to bed."*, which means that there are few variability in the data in these two variables. It is possible to dispense with these data for the analysis, since they do not contribute much information to the studied phenomenon for this population. The other 19 categorical variables for SHI, have a cardinality of 5, and the higher mode is placed in SH10  *"I use cafeine within 4 hours of going to bed or after going to bed."* were a $66.98\%$ of the respondents answered *never ($0$)* for this question. This means that the answers have a good range of variability to be analized, and to participate as candidate of be selected as feature to training the model.

### Missing values
This set of data has small number of missing values, however, in this case it is possible to impute data due to the features together represents a behavior of the person. The KNN algorithm performs data imputation using similarity, thus, in this case a good approximation to the true data could be computed taken as reference the 20 remaining features of the neighbors to determine the missing value.


| Feature | Data quality issue           | Strategie                                                                                                                                                                                                                                            |
|---------|------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| SH8     | The mode is very high (>94%) | Analyze the relevance of include this variable to the analysis due the few variability                                                                                                                                                               |
| SH9     | The mode is high (>81%)      | Analyze the relevance of include this variable to the analysis due the few variability                                                                                                                                                               |
| All     | Missing values               | The percentage of missing values is small, however imputation will be performed for those records with missing values after the deletion of records with missing values in the others set of data (continuous and demographic-categorical features)  |

Table: Potential-strategies-to-attend-SH-features


```{r recordwithNA}
#identifica el índice del registro donde existe un valor faltante
recNA<-c(which(is.na(QS_data$DD1)),which(is.na(QS_data$SQ1)),which(is.na(QS_data$SQ2)), which(is.na(QS_data$SQ3)),which(is.na(QS_data$SQ4)))
#elimina los índices repetidos
recNA<-unique(recNA)
#elimina los registros donde hay faltantes
QS_data<-QS_data[-recNA,]
#reestructura los índices del dataset
rownames(QS_data)<-1:nrow(QS_data)

#duplicated(recNA) #función que encuentra los duplicados en un vector
```



### Outliers

Histograms and boxplot were generated to observe the behaviour of the data. 
```{r histograms-bocplots}
library(ggplot2)

histDD1<-ggplot(data=QS_data,aes(DD1))+geom_histogram(bins = 30)+labs(y="Count")
histSQ1<-ggplot(data=QS_data,aes(SQ1))+geom_histogram(bins = 30)+labs(y="Count")
histSQ2<-ggplot(data=QS_data,aes(SQ2))+geom_histogram(bins = 30)+labs(y="Count")
histSQ3<-ggplot(data=QS_data,aes(SQ3))+geom_histogram(bins = 30)+labs(y="Count")
histSQ4<-ggplot(data=QS_data,aes(SQ4))+geom_histogram(bins = 30)+labs(y="Count")

boxplotDD1<-ggplot(data=QS_data, aes(as.factor(DD2),DD1))+geom_boxplot()+labs(x="Gender")
boxplotSQ1<-ggplot(data=QS_data, aes(as.factor(DD2),SQ1))+geom_boxplot()+labs(x="Gender")
boxplotSQ2<-ggplot(data=QS_data, aes(as.factor(DD2),SQ2))+geom_boxplot()+labs(x="Gender")
boxplotSQ3<-ggplot(data=QS_data, aes(as.factor(DD2),SQ3))+geom_boxplot()+labs(x="Gender")
boxplotSQ4<-ggplot(data=QS_data, aes(as.factor(DD2),SQ4))+geom_boxplot()+labs(x="Gender")


multiplot(histDD1,histSQ1,histSQ2,histSQ3,histSQ4,boxplotDD1,boxplotSQ1,boxplotSQ2,boxplotSQ3,boxplotSQ4,cols=2)
```

The plots show that there exist outliers in the data, so an analytics procedure was performed to obtain the records containing the outliers. Values out of the three standard deviation were considered as outliers for each variable.

```{r scoring-outliers}
library(outliers)
library(magrittr)
ic<-0.99

outDD1<-scores(QS_data$DD1,type = "z",prob = ic)%>%which(.)
outSQ1<-scores(QS_data$SQ1,type = "z",prob = ic)%>%which(.)
outSQ2<-scores(QS_data$SQ2,type = "z",prob = ic)%>%which(.)
outSQ3<-scores(QS_data$SQ3,type = "z",prob = ic)%>%which(.)
outSQ4<-scores(QS_data$SQ4,type = "z",prob = ic)%>%which(.)
```



In the other hand, there are missing values in this dataset, in order to procede to next step, it is important to solve 

```{r report-of-quality-catfeat}
dfCATFEAT<-cbind.data.frame(QS_data[,3:9],QS_data[,14:48])
DRCAT<-QOfCategoricalF(dfCATFEAT)
DRCAT


which(is.na(QS_data$DD1)) 
```

<!--  17 151 154 203 206 239 -->

```{r}
# library(yaImpute)
# library(randomForest)
# x<-QS_data[,3:9]
# y<-QS_data$DD1
# mal<-yai(x=x,y=y,method = "randomForest")
# impute(mal)
# malImp=impute(mal,ancillaryData=QS_data)
# plot(malImp)

```


# Analysis of quality on ABT

The dataset for this work is generated in two stages, the first one obtains the data through the answers of the respondents, while in the second new columns are generated by the computation of the scales of the PSQI and SHI questionnaires. At the end of the first stage, a report of data quality was generated with exploratory purposes. Some relevant decisions will be taken as result of this observation, for instance, if all columns should be part of the final dataset, depending of the quantity of missing values are on them.



The dataset obtained by the answers of the respondents is a `r dim(d_crudos)[1]`  x `r dim(d_crudos)[2]` dataset, it contains  



As first step, the ABT will be grouped as Table \@ref(tab-columns-distribution) shows the distribution of variables. ABT contains five groups of variables and each group will be divided in categorical and continuous variables to perform the analysis. At the end, eight tables of analysis of quality will be generated since there are two groups that contains only one type of variables (the SHI group have only  categorical variables, while the Scale SHI contains only continuous variables).

## Meaning of the groups names

  * DDCON:    Demografic data for contiuous variables
  * DDCAT:    Demografic data for categorical variables
  * PSQICON:  Continuous variables of the PSQI questionnaire
  * PSQICAT:  Categorical variables of the PSQI questionnaire
  * SHICAT:   Categorical variables of the SHI questionnaire
  * SPSQICON: Continuous variables of the *scale* for PSQI questionnaire
  * SPSQICAT: Categorical variables of the *scale* for PSQI questionnaire
  * SSHICON:  Continuous variables of the *scale* for SHI questionnaire
  * SSHICAT:  Categorical variables of the *scale* for SHI questionnaire


```{r, grouping_variables, echo=FALSE}

DDCON<-data.frame(DD1=d_preproc[,2]) #data.frame(NM=d_preproc[,1],DD1=as.factor(d_preproc[,2]))
DDCAT<-d_preproc[,3:8]
PSQICON<-d_preproc[,10:13] 
PSQICAT<-d_preproc[,14:27] 
SHICAT<- d_preproc[,28:48]   
SPSQICON<-data.frame(SQTT=d_preproc[,56])
SPSQICAT<-cbind.data.frame(d_preproc[,49:55],SQCL=d_preproc[,57])
SSHICON<- d_preproc[,58:62]   
```


## Tables containing data for analysis of the continuous variables 

```{r QofCD_execution}
CONTFEAT<-QOfContinuousF(cbind.data.frame(DDCON,PSQICON,SPSQICON,SSHICON))
CONTFEAT

#Arreglar las funciones en github 
#Qrt1<-apply(cbind.data.frame(DDCON,PSQICON,SPSQICON,SSHICON),2,FUN = function(x) round(quantile(as.numeric(x),.25,na.rm = T),digits = 2))


Miss<- apply(responses,2,FUN = function(x)  sum(is.na(x)))


```


## Tables containing data for analysis of the categorical variables 




